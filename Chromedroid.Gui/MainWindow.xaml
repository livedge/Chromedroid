<ui:FluentWindow x:Class="Chromedroid.Gui.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
        xmlns:local="clr-namespace:Chromedroid.Gui"
        Title="Chromedroid Device Monitor"
        Width="720" Height="480"
        MinWidth="500" MinHeight="300"
        ExtendsContentIntoTitleBar="True"
        WindowBackdropType="Mica">
    <ui:FluentWindow.Resources>
        <local:DeviceStateToColorConverter x:Key="StateToColor" />
        <local:NicknameToVisibilityConverter x:Key="NicknameToVisibility" />
        <local:ErrorToSeverityConverter x:Key="ErrorToSeverity" />
    </ui:FluentWindow.Resources>
    <ui:FluentWindow.InputBindings>
        <KeyBinding Key="F5" Command="{Binding RefreshCommand}" />
    </ui:FluentWindow.InputBindings>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <ui:TitleBar Grid.Row="0" Title="Chromedroid Device Monitor" />

        <!-- Main content: master-detail -->
        <Grid Grid.Row="1" Margin="8,0,8,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="240" MinWidth="180" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!-- Device list (left panel) -->
            <DockPanel Grid.Column="0">
                <DockPanel DockPanel.Dock="Top" Margin="0,0,0,8">
                    <TextBlock Text="Connected Devices"
                               FontWeight="SemiBold" FontSize="14"
                               VerticalAlignment="Center" />
                    <ui:Button HorizontalAlignment="Right"
                               Command="{Binding RefreshCommand}"
                               Icon="{ui:SymbolIcon ArrowClockwise24}"
                               ToolTip="Refresh (F5)" />
                </DockPanel>
                <ListView ItemsSource="{Binding Devices}"
                          SelectedItem="{Binding SelectedDevice}"
                          HorizontalContentAlignment="Stretch"
                          ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                    <ListView.ItemTemplate>
                        <DataTemplate DataType="{x:Type local:DeviceViewModel}">
                            <ui:Card Margin="0,0,0,4"
                                     MouseDoubleClick="DeviceCard_MouseDoubleClick">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="{Binding DisplayName}"
                                                   FontWeight="Bold" FontSize="13" />
                                        <TextBlock Text="{Binding Model}"
                                                   FontSize="11" Opacity="0.7"
                                                   Visibility="{Binding Nickname, Converter={StaticResource NicknameToVisibility}}" />
                                        <TextBlock Text="{Binding DeviceInfo}"
                                                   FontSize="11" Opacity="0.6"
                                                   Visibility="{Binding DeviceInfo, Converter={StaticResource NicknameToVisibility}}" />
                                        <TextBlock Text="{Binding Serial}"
                                                   FontSize="10" Opacity="0.5"
                                                   Margin="0,2,0,0" />
                                    </StackPanel>
                                    <ui:Button Grid.Column="1"
                                               Appearance="Transparent"
                                               Command="{Binding IdentifyCommand}"
                                               Icon="{ui:SymbolIcon Flashlight24}"
                                               ToolTip="Flash screen to identify device"
                                               VerticalAlignment="Top"
                                               Margin="4,0,0,0"
                                               Padding="4" />
                                    <Ellipse Grid.Column="2"
                                             Width="10" Height="10"
                                             Fill="{Binding State, Converter={StaticResource StateToColor}}"
                                             VerticalAlignment="Top"
                                             Margin="8,4,0,0" />
                                </Grid>
                            </ui:Card>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
            </DockPanel>

            <GridSplitter Grid.Column="1"
                          Width="4"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Stretch" />

            <!-- Browser status (right panel) -->
            <DockPanel Grid.Column="2" Margin="8,0,0,0">
                <TextBlock DockPanel.Dock="Top"
                           Text="Browser Status"
                           FontWeight="SemiBold" FontSize="14"
                           Margin="0,0,0,8" />
                <ItemsControl ItemsSource="{Binding SelectedDevice.RunningBrowsers}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="{x:Type local:BrowserStatusItem}">
                            <ui:CardAction Margin="0,0,0,4" IsChevronVisible="False">
                                <StackPanel Orientation="Horizontal">
                                    <ui:SymbolIcon Symbol="Globe24"
                                                   Margin="0,0,8,0" />
                                    <StackPanel>
                                        <TextBlock Text="{Binding DisplayName}"
                                                   FontWeight="SemiBold" FontSize="12" />
                                        <TextBlock Text="{Binding PackageName}"
                                                   Opacity="0.6" FontSize="10" />
                                    </StackPanel>
                                </StackPanel>
                            </ui:CardAction>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </DockPanel>
        </Grid>

        <!-- InfoBar status -->
        <ui:InfoBar Grid.Row="2"
                    Title="{Binding StatusText}"
                    Message="{Binding ErrorText}"
                    IsOpen="True"
                    IsClosable="False"
                    Severity="{Binding ErrorText, Converter={StaticResource ErrorToSeverity}}"
                    Margin="8,0,8,8" />
    </Grid>
</ui:FluentWindow>
